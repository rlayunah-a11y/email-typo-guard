import os
import sqlite3
import smtplib
import pandas as pd
import gradio as gr
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
from collections import Counter
from io import BytesIO
from datetime import datetime

# ì´ë©”ì¼ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage

# -----------------------------------------------------------------------------
# 1. í™˜ê²½ ì„¤ì • ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (í•œê¸€ í°íŠ¸ & Hanspell)
# -----------------------------------------------------------------------------
# í°íŠ¸ íŒŒì¼ ê²½ë¡œ ì •ì˜ (Colab ì„¤ì¹˜ ê¸°ì¤€)
FONT_PATH = '/usr/share/fonts/truetype/nanum/NanumBarunGothic.ttf'

def setup_environment():
    # Hanspell ì„¤ì¹˜
    try:
        from hanspell import spell_checker
    except ImportError:
        print("â³ Hanspell ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì¤‘...")
        os.system("pip install git+https://github.com/ssut/py-hanspell.git")
    
    # í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (Colabìš©)
    if not os.path.exists(FONT_PATH):
        print("â³ í•œê¸€ í°íŠ¸(ë‚˜ëˆ”ë°”ë¥¸ê³ ë”•) ì„¤ì¹˜ ë° ìºì‹œ ì´ˆê¸°í™” ì¤‘...")
        os.system("sudo apt-get install -y fonts-nanum")
        os.system("sudo fc-cache -fv")
        os.system("rm ~/.cache/matplotlib -rf")
        print("âœ… í°íŠ¸ ì„¤ì¹˜ ì™„ë£Œ")

setup_environment()
from hanspell import spell_checker

# -----------------------------------------------------------------------------
# 2. ìƒìˆ˜ ë° ì„¤ì • ì •ì˜
# -----------------------------------------------------------------------------
DB_NAME = "mail_data.db"
CSV_FILE_PATH = "business_email_errors_augmented_300.csv"  # ë¶„ì„ ëŒ€ìƒ íŒŒì¼
SENDER_EMAIL = 'ë°œì‹ ìì´ë©”ì¼@gmail.com'
APP_PASSWORD = '16ìë¦¬ë¦¬'  # ë³¸ì¸ì˜ ì•± ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ìš”

# -----------------------------------------------------------------------------
# 3. ë°ì´í„° ìœ í‹¸ë¦¬í‹° (CSV ë¶„ì„ & DB)
# -----------------------------------------------------------------------------
def init_db():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS mail_logs 
                 (id INTEGER PRIMARY KEY AUTOINCREMENT, 
                  body TEXT, typos TEXT, is_correct_feedback INTEGER, timestamp TEXT)''')
    conn.commit()
    conn.close()

init_db()

def get_data_analysis():
    """
    CSV íŒŒì¼ì„ ì½ì–´ ë‘ ê°€ì§€ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    1. recent_stats: ìµœê·¼ 20ê±´ì— ëŒ€í•œ Top 5 (ë¦¬ìŠ¤íŠ¸/í‘œ ìš©ë„)
    2. cumulative_stats: ì „ì²´ ëˆ„ì  ë°ì´í„°ì— ëŒ€í•œ Top 5 (ê·¸ë˜í”„ ìš©ë„)
    """
    default_result = ([], []) # (top_spans, top_types)

    if not os.path.exists(CSV_FILE_PATH):
        return default_result, default_result

    try:
        # íŒŒì¼ ì½ê¸°
        try:
            df = pd.read_csv(CSV_FILE_PATH, encoding='utf-8')
        except:
            df = pd.read_csv(CSV_FILE_PATH, encoding='cp949')
            
        if df.empty:
            return default_result, default_result

        # --- ìµœê·¼ 20ê±´ ë¶„ì„ (ë¦¬ìŠ¤íŠ¸) ---
        recent_df = df.tail(20)
        
        # ë‹¨ì–´
        if 'span' in recent_df.columns:
            recent_span_counts = Counter(recent_df['span'].dropna().astype(str))
            recent_top_spans = recent_span_counts.most_common(5)
        else:
            recent_top_spans = []

        # ì—ëŸ¬ ìœ í˜•
        if 'error_type' in recent_df.columns:
            recent_type_counts = Counter(recent_df['error_type'].dropna().astype(str))
            recent_top_types = recent_type_counts.most_common(5)
        else:
            recent_top_types = []

        recent_stats = (recent_top_spans, recent_top_types)


        # --- ì „ì²´ ëˆ„ì  ë¶„ì„ (ê·¸ë˜í”„) ---
        # ì „ì²´ df ì‚¬ìš©
        
        # ë‹¨ì–´
        if 'span' in df.columns:
            cum_span_counts = Counter(df['span'].dropna().astype(str))
            cum_top_spans = cum_span_counts.most_common(5)
        else:
            cum_top_spans = []

        # ì—ëŸ¬ ìœ í˜•
        if 'error_type' in df.columns:
            cum_type_counts = Counter(df['error_type'].dropna().astype(str))
            cum_top_types = cum_type_counts.most_common(5)
        else:
            cum_top_types = []

        cumulative_stats = (cum_top_spans, cum_top_types)

        return recent_stats, cumulative_stats

    except Exception as e:
        print(f"CSV ë¶„ì„ ì—ëŸ¬: {e}")
        return default_result, default_result

# -----------------------------------------------------------------------------
# 4. ê·¸ë˜í”„ ìƒì„± (ëˆ„ì  ë°ì´í„° ì‚¬ìš© + í•œê¸€ í°íŠ¸ ì ìš©)
# -----------------------------------------------------------------------------
def make_bar_png(items, title, color='#6c5ce7'):
    """
    (ë¼ë²¨, ê°’) ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ ë§‰ëŒ€ê·¸ë˜í”„ PNG ë°”ì´ë„ˆë¦¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    if not items:
        items = [("ë°ì´í„° ì—†ìŒ", 0)]

    # í°íŠ¸ ì†ì„± ì„¤ì •
    try:
        font_prop = fm.FontProperties(fname=FONT_PATH)
    except:
        font_prop = fm.FontProperties(family='sans-serif')

    labels = [str(k) for k, v in items]
    values = [v for k, v in items]

    fig, ax = plt.subplots(figsize=(6, 3.5))
    bars = ax.bar(labels, values, color=color, alpha=0.8)
    
    # ê°’ í‘œì‹œ (í°íŠ¸ ì ìš©)
    for bar in bars:
        height = bar.get_height()
        ax.text(bar.get_x() + bar.get_width()/2.0, height, f'{int(height)}', 
                ha='center', va='bottom', fontproperties=font_prop)

    # ì œëª© ë° ì¶• ë¼ë²¨ (í°íŠ¸ ì ìš©)
    ax.set_title(title, fontsize=12, fontweight='bold', fontproperties=font_prop)
    ax.set_ylabel("ë°œìƒ íšŸìˆ˜", fontproperties=font_prop)
    plt.xticks(rotation=15, fontproperties=font_prop)
    plt.yticks(fontproperties=font_prop)
    
    plt.tight_layout()

    buf = BytesIO()
    plt.savefig(buf, format="png", dpi=150)
    plt.close(fig)
    buf.seek(0)
    return buf.getvalue()

# -----------------------------------------------------------------------------
# 5. HTML ì´ë©”ì¼ í¬ë§·íŒ… (ë¦¬ìŠ¤íŠ¸=ìµœê·¼20ê±´ / ê·¸ë˜í”„=ëˆ„ì )
# -----------------------------------------------------------------------------
def build_html_report(error_count, current_errors, recent_stats, cumulative_stats):
    """
    ì´ë©”ì¼ ë³¸ë¬¸(HTML)ì„ ìƒì„±í•©ë‹ˆë‹¤.
    """
    recent_spans, recent_types = recent_stats
    # cumulative_statsëŠ” ê·¸ë˜í”„ ìƒì„±ì— ì‚¬ìš©ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì§ì ‘ ì¶œë ¥í•˜ì§€ ì•Šê±°ë‚˜ 
    # ê·¸ë˜í”„ ì œëª©ìœ¼ë¡œ êµ¬ë¶„í•¨.

    # 1. í˜„ì¬ ë©”ì¼ ì˜¤íƒ€ ë¦¬ìŠ¤íŠ¸ HTML
    current_error_rows = ""
    for w, c in current_errors:
        current_error_rows += f"<li>âŒ <b>{w}</b> â†’ â­• {c}</li>"

    # 2. [ë¦¬ìŠ¤íŠ¸] ìµœê·¼ 20ê±´ í†µê³„ HTML
    stats_rows = ""
    if recent_spans:
        for idx, (word, cnt) in enumerate(recent_spans, 1):
            stats_rows += f"""
            <tr>
                <td style="padding:5px; border-bottom:1px solid #eee;">{idx}</td>
                <td style="padding:5px; border-bottom:1px solid #eee; font-weight:bold;">{word}</td>
                <td style="padding:5px; border-bottom:1px solid #eee; text-align:center;">{cnt}íšŒ</td>
            </tr>
            """
    else:
        stats_rows = "<tr><td colspan='3'>ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</td></tr>"

    html_content = f"""
    <div style="font-family:'Malgun Gothic', AppleSDGothicNeo, sans-serif; color:#333; max-width:600px; line-height:1.6;">
        <h2 style="color:#d63031;">ğŸš« ë©”ì¼ ë°œì†¡ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</h2>
        <p>ì‘ì„±í•˜ì‹  ë©”ì¼ì—ì„œ <b>{error_count}ê±´</b>ì˜ ì˜¤íƒ€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        
        <div style="background-color:#fff5f5; padding:15px; border-radius:10px; border:1px solid #ffcccc;">
            <h3 style="margin-top:0;">ğŸ” ë©”ì¼ êµì • ì œì•ˆ</h3>
            <ul>{current_error_rows}</ul>
        </div>

        <br>
        <hr style="border:0; border-top:2px solid #eee;">
        
        <h3>ğŸ“Š ìµœê·¼ ì˜¤íƒ€ ë°ì´í„° ë¦¬í¬íŠ¸</h3>
        <p style="font-size:12px; color:#666;">* ê°€ì¥ ìµœê·¼ ìˆ˜ì§‘ëœ ë©”ì¼ ë¡œê·¸ 20ê±´ì—ì„œ ìì£¼ ë°œìƒí•œ ì˜¤íƒ€ì…ë‹ˆë‹¤.</p>
        
        <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
            <tr style="background-color:#f1f2f6;">
                <th style="padding:8px; text-align:left;">ìˆœìœ„</th>
                <th style="padding:8px; text-align:left;">ìì£¼ í‹€ë¦° í‘œí˜„</th>
                <th style="padding:8px; text-align:center;">íšŸìˆ˜</th>
            </tr>
            {stats_rows}
        </table>

        <br>
        <h3>ğŸ“ˆ ì „ì²´ ëˆ„ì  ë°ì´í„° ê·¸ë˜í”„</h3>
        <p style="font-size:12px; color:#666;">* ì‚¬ë‚´ì— ì¶•ì ëœ <b>ì „ì²´ ë°ì´í„°</b>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ í†µê³„ì…ë‹ˆë‹¤.</p>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <h4 style="text-align:center;">ëˆ„ì  Top 5 ì˜¤íƒ€ ë‹¨ì–´</h4>
                <img src="cid:chart_spans" style="width:100%; border-radius:8px; border:1px solid #eee;">
            </div>
            <div style="flex:1;">
                <h4 style="text-align:center;">ëˆ„ì  Top 5 ì—ëŸ¬ ìœ í˜•</h4>
                <img src="cid:chart_types" style="width:100%; border-radius:8px; border:1px solid #eee;">
            </div>
        </div>
    </div>
    """
    return html_content

# -----------------------------------------------------------------------------
# 6. ì´ë©”ì¼ ì „ì†¡ í•¨ìˆ˜
# -----------------------------------------------------------------------------
def send_report_email(receiver, subject, html_body, images):
    msg = MIMEMultipart("related")
    msg["From"] = SENDER_EMAIL
    msg["To"] = receiver
    msg["Subject"] = subject

    # HTML ë³¸ë¬¸
    msg.attach(MIMEText(html_body, "html", _charset="utf-8"))

    # ì´ë¯¸ì§€ ì²¨ë¶€
    for img_data in images:
        img = MIMEImage(img_data['bytes'], _subtype="png")
        img.add_header('Content-ID', f"<{img_data['cid']}>")
        msg.attach(img)

    try:
        server = smtplib.SMTP("smtp.gmail.com", 587)
        server.starttls()
        server.login(SENDER_EMAIL, APP_PASSWORD)
        server.sendmail(SENDER_EMAIL, receiver, msg.as_string())
        server.quit()
        return True
    except Exception as e:
        print(f"ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: {e}")
        return False

# -----------------------------------------------------------------------------
# 7. ë©”ì¼(Main)
# -----------------------------------------------------------------------------
def check_spelling(text):
    found_details = []
    
    # ë¹„ìƒìš© ë‚´ë¶€ ì‚¬ì „
    fallback_dict = {
        "ì—­í™œ": "ì—­í• ", "ë´½ê² ìŠµë‹ˆë‹¤": "ëµ™ê² ìŠµë‹ˆë‹¤", "ê²°ì œ": "ê²°ì¬",
        "ì–´ë–»í•´": "ì–´ë–¡í•´", "ë˜ìš”": "ë¼ìš”", "ë¡œì¨": "ë¡œì„œ", "í™”ì‹ ": "íšŒì‹ "
    }
    for wrong, correct in fallback_dict.items():
        if wrong in text:
            found_details.append((wrong, correct))

    # Hanspell ê²€ì‚¬
    try:
        spelled = spell_checker.check(text)
        for key, value in spelled.words.items():
            if value == 2 and key not in [x[0] for x in found_details]:
                found_details.append((key, "(ë§ì¶¤ë²• ì˜¤ë¥˜)"))
    except:
        pass
    
    return len(found_details), found_details

def process_email(receiver, subject, body):
    # ì˜¤íƒ€ ê²€ì‚¬
    error_count, error_details = check_spelling(body)
    
    # DB ê¸°ë¡
    typos_str = ", ".join([f"{w}->{c}" for w, c in error_details])
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("INSERT INTO mail_logs (body, typos, is_correct_feedback, timestamp) VALUES (?, ?, ?, ?)",
              (body, typos_str, 0, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
    last_id = c.lastrowid
    conn.commit()
    conn.close()

    if error_count == 0:
        # ì •ìƒ ë°œì†¡
        sender_email = SENDER_EMAIL
        msg = MIMEMultipart()
        msg['From'] = sender_email
        msg['To'] = receiver
        msg['Subject'] = subject
        msg.attach(MIMEText(body, 'plain'))
        try:
            s = smtplib.SMTP('smtp.gmail.com', 587)
            s.starttls()
            s.login(sender_email, APP_PASSWORD)
            s.sendmail(sender_email, receiver, msg.as_string())
            s.quit()
            gr.Info("âœ… ë°œì†¡ ì„±ê³µ")
            return last_id, gr.update(visible=False)
        except:
            gr.Warning("âŒ ë°œì†¡ ì‹¤íŒ¨")
            return last_id, gr.update(visible=False)
    else:
        # ğŸš« ì°¨ë‹¨ ë° ë¦¬í¬íŠ¸ ë°œì†¡
        gr.Warning(f"ğŸš« ì˜¤íƒ€ {error_count}ê±´ ê°ì§€! ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ë°œì†¡ë©ë‹ˆë‹¤.")

        # ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìµœê·¼20ê±´ / ëˆ„ì )
        recent_stats, cumulative_stats = get_data_analysis()
        
        # ì–¸íŒ¨í‚¹
        cum_spans, cum_types = cumulative_stats

        # ê·¸ë˜í”„ ìƒì„± -> [ì¤‘ìš”] 'ëˆ„ì  ë°ì´í„°(cumulative_stats)' ì‚¬ìš©
        img_spans = make_bar_png(cum_spans, "ëˆ„ì  ìì£¼ í‹€ë¦° í‘œí˜„ Top 5", color='#ff7675')
        img_types = make_bar_png(cum_types, "ëˆ„ì  ì˜¤íƒ€ ìœ í˜• ë¶„í¬ Top 5", color='#74b9ff')

        # HTML ìƒì„± -> [ì¤‘ìš”] ë¦¬ìŠ¤íŠ¸ëŠ” 'ìµœê·¼ ë°ì´í„°(recent_stats)' ì‚¬ìš©
        html_body = build_html_report(error_count, error_details, recent_stats, cumulative_stats)

        # ì´ë¯¸ì§€ íŒ¨í‚¤ì§•
        images = [
            {'cid': 'chart_spans', 'bytes': img_spans},
            {'cid': 'chart_types', 'bytes': img_types}
        ]

        # ë¦¬í¬íŠ¸ ë©”ì¼ ë°œì†¡
        send_report_email(SENDER_EMAIL, f"[ê²½ê³ ] ë©”ì¼ ë°œì†¡ ì°¨ë‹¨ (ì˜¤íƒ€ {error_count}ê±´)", html_body, images)
        
        return last_id, gr.update(visible=True)

def submit_feedback(row_id, feedback_val):
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    val = 1 if feedback_val == "ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤" else 0
    c.execute("UPDATE mail_logs SET is_correct_feedback = ? WHERE id = ?", (val, row_id))
    conn.commit()
    conn.close()
    gr.Info("í”¼ë“œë°±ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return "ë°˜ì˜ ì™„ë£Œ"

# -----------------------------------------------------------------------------
# 8. UI ì‹¤í–‰
# -----------------------------------------------------------------------------
with gr.Blocks(theme=gr.themes.Soft()) as demo:
    gr.Markdown("## ğŸ“§ ìŠ¤ë§ˆíŠ¸ ë©”ì¼ ì‹œìŠ¤í…œ")
    
    with gr.Row():
        with gr.Column(scale=2):
            receiver_input = gr.Textbox(label="ìˆ˜ì‹ ì ì´ë©”ì¼")
            subject_input = gr.Textbox(label="ì œëª©")
            content_input = gr.TextArea(label="ë³¸ë¬¸ ë‚´ìš©", lines=12, placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...")
            send_btn = gr.Button("ë©”ì¼ ë³´ë‚´ê¸°", variant="primary")
        
        with gr.Column(scale=1):
            current_log_id = gr.State()
            with gr.Group(visible=False) as feedback_area:
                gr.Markdown("### ğŸ§ ê²€ì¦ í”¼ë“œë°±")
                feedback_radio = gr.Radio(["ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤", "ì•„ë‹ˆìš”"], label="íŒë‹¨")
                feedback_btn = gr.Button("ì œì¶œ")
                feedback_msg = gr.Markdown("")

    send_btn.click(fn=process_email, inputs=[receiver_input, subject_input, content_input], outputs=[current_log_id, feedback_area])
    feedback_btn.click(fn=submit_feedback, inputs=[current_log_id, feedback_radio], outputs=feedback_msg)

demo.launch(share=True)
