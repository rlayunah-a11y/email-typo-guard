import gradio as gr

import smtplib

import sqlite3

import pandas as pd

from email.mime.multipart import MIMEMultipart

from email.mime.text import MIMEText

from datetime import datetime

from hanspell import spell_checker



# ==========================================

# 1. DB ì„¤ì • (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)

# ==========================================

DB_NAME = "mail_data.db"



def init_db():

    conn = sqlite3.connect(DB_NAME)

    c = conn.cursor()

    c.execute('''CREATE TABLE IF NOT EXISTS mail_logs 

                 (id INTEGER PRIMARY KEY AUTOINCREMENT, 

                  body TEXT, typos TEXT, is_correct_feedback INTEGER, timestamp TEXT)''')

    conn.commit()

    conn.close()



init_db()



# ==========================================

# 2. ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜ (ì„±ê³µí•œ ì½”ë“œ í˜•ì‹ ê·¸ëŒ€ë¡œ ì ìš©)

# ==========================================

def send_email(receiver, subject, body):

    

    # --------------------------------------------------------

    # ë³¸ì¸ì˜ ì •ë³´ ì…ë ¥

    # --------------------------------------------------------

    sender_email = 'ooo@gmail.com'  # ë³¸ì¸ ì´ë©”ì¼

    password = '16ìë¦¬'         # ì•± ë¹„ë°€ë²ˆí˜¸

    # --------------------------------------------------------

    

    # ìˆ˜ì‹ ì ì´ë©”ì¼ ë³€ìˆ˜ í• ë‹¹

    receiver_email = receiver



    # MIME ê°ì²´ ìƒì„± (ì£¼ì‹  ì½”ë“œ ê·¸ëŒ€ë¡œ)

    msg = MIMEMultipart()

    msg['From'] = sender_email

    msg['To'] = receiver_email

    msg['Subject'] = subject

    msg.attach(MIMEText(body, 'plain'))



    try:

        # Gmail SMTP ì„œë²„ì— ì—°ê²°í•˜ê³  ì´ë©”ì¼ ë³´ë‚´ê¸° (ì£¼ì‹  ì½”ë“œ ê·¸ëŒ€ë¡œ)

        server = smtplib.SMTP('smtp.gmail.com', 587)

        server.starttls()          # TLS ë³´ì•ˆ ì—°ê²°

        server.login(sender_email, password)  # ë¡œê·¸ì¸



        # ì´ë©”ì¼ ë°œì†¡

        text = msg.as_string()

        server.sendmail(sender_email, receiver_email, text)



        # ì„œë²„ ì—°ê²° ì¢…ë£Œ

        server.quit()

        return True

        

    except Exception as e:

        print(f"ì „ì†¡ ì—ëŸ¬: {e}")

        return False



# ==========================================

# 3. [ì•ˆì „ì¥ì¹˜] ë‚´ë¶€ ì˜¤íƒ€ ê²€ì‚¬ (ë„¤ì´ë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‘ë™)

# ==========================================

def local_fallback_check(text):

    """ë„¤ì´ë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•˜ëŠ” ë¹„ìƒìš© ì‚¬ì „"""

    typo_dictionary = {

        "ì—­í™œ": "ì—­í• ",

        "ë´½ê² ìŠµë‹ˆë‹¤": "ëµ™ê² ìŠµë‹ˆë‹¤",

        "ê²°ì œ": "ê²°ì¬",

        "ì–´ë–»í•´": "ì–´ë–¡í•´",

        "ë˜ìš”": "ë¼ìš”",

        "ë¡œì¨": "ë¡œì„œ"

    }

    found_typos = []

    for wrong in typo_dictionary:

        if wrong in text:

            found_typos.append(wrong)

    return len(found_typos), found_typos



# ==========================================

# 4. ë³´ê³ ì„œ ë°œì†¡ í•¨ìˆ˜

# ==========================================

def send_summary_report():

    conn = sqlite3.connect(DB_NAME)

    df = pd.read_sql_query("SELECT * FROM mail_logs ORDER BY id DESC LIMIT 100", conn)

    conn.close()

    

    if len(df) == 0: return



    total = len(df)

    accuracy = (df['is_correct_feedback'].sum() / total) * 100

    

    report_subj = f"[System Report] ë°ì´í„° ë¶„ì„ ë³´ê³ ì„œ"

    report_msg = f"ë¶„ì„ ë°ì´í„°: {total}ê±´ / ì •í™•ë„: {accuracy:.2f}%"

    

    # ë³´ê³ ì„œëŠ” ë‚˜ ìì‹ ì—ê²Œ ë³´ëƒ„

    # (sender_emailì€ í•¨ìˆ˜ ì•ˆì— ìˆì–´ì„œ, ì—¬ê¸°ì„œëŠ” í•˜ë“œì½”ë”©ëœ ì£¼ì†Œë‚˜ ë³„ë„ ì²˜ë¦¬ê°€ í•„ìš”í•˜ì§€ë§Œ

    #  í¸ì˜ìƒ send_email í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤. ìˆ˜ì‹ ìì— ë³¸ì¸ ì´ë©”ì¼ì„ ì ì–´ì£¼ì„¸ìš”.)

    my_email = 'ooo@gmail.com' # [ìˆ˜ì • í•„ìš”] ë³¸ì¸ ì´ë©”ì¼

    send_email(my_email, report_subj, report_msg)



# ==========================================

# 5. ë©”ì¸ ë¡œì§ (í•˜ì´ë¸Œë¦¬ë“œ ê²€ì‚¬ + DB + ë°œì†¡)

# ==========================================

def process_email(receiver, subject, body):

    

    is_naver = False

    

    # 1. ë§ì¶¤ë²• ê²€ì‚¬ (ë„¤ì´ë²„ ì‹œë„ -> ì‹¤íŒ¨ì‹œ ë‚´ë¶€ì‚¬ì „)

    try:

        spelled = spell_checker.check(body)

        error_count = spelled.errors

        typo_list = [key for key, _ in spelled.words.items() if _ == 2]

        typos_str = ", ".join(typo_list)

        is_naver = True

    except:

        error_count, typo_list = local_fallback_check(body)

        typos_str = ", ".join(typo_list)

        is_naver = False



    # 2. DB ì €ì¥

    conn = sqlite3.connect(DB_NAME)

    c = conn.cursor()

    c.execute("INSERT INTO mail_logs (body, typos, is_correct_feedback, timestamp) VALUES (?, ?, ?, ?)",

              (body, typos_str, 0, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))

    last_id = c.lastrowid

    

    # ë³´ê³ ì„œ ë°œì†¡ ì²´í¬ (ë°ì´í„° 10ê±´ë§ˆë‹¤)

    c.execute("SELECT COUNT(*) FROM mail_logs")

    if c.fetchone()[0] % 10 == 0:

        send_summary_report()

    conn.commit()

    conn.close()



    # 3. ê²°ê³¼ ë¶„ê¸°

    if error_count == 0:

        # ì˜¤íƒ€ ì—†ìŒ -> ë°œì†¡ ì‹œë„

        if send_email(receiver, subject, body):

            msg = "âœ… ë°œì†¡ ì„±ê³µ!"

            if not is_naver: msg += " (ë°±ì—… ì‹œìŠ¤í…œ ë™ì‘)"

            gr.Info(msg)

            return last_id, gr.update(visible=False)

        else:

            gr.Warning("âŒ ë°œì†¡ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

            return last_id, gr.update(visible=False)

    else:

        # ì˜¤íƒ€ ìˆìŒ -> ë°œì†¡ ì°¨ë‹¨

        msg = f"ğŸš« ì˜¤íƒ€ {error_count}ê°œ ë°œê²¬! ë°œì†¡ ì¤‘ë‹¨.\n[ëª©ë¡] {typos_str}"

        gr.Warning(msg)

        return last_id, gr.update(visible=True)



# ==========================================

# 6. í”¼ë“œë°± í•¨ìˆ˜

# ==========================================

def submit_feedback(row_id, feedback_val):

    conn = sqlite3.connect(DB_NAME)

    c = conn.cursor()

    val = 1 if feedback_val == "ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤" else 0

    c.execute("UPDATE mail_logs SET is_correct_feedback = ? WHERE id = ?", (val, row_id))

    conn.commit()

    conn.close()

    gr.Info("í”¼ë“œë°± ë°˜ì˜ ì™„ë£Œ!")

    return "ë°˜ì˜ ì™„ë£Œ"



# ==========================================

# 7. UI êµ¬ì„±

# ==========================================

with gr.Blocks(theme=gr.themes.Soft()) as demo:

    gr.Markdown("## ğŸ“§ ìŠ¤ë§ˆíŠ¸ ë©”ì¼ ì‹œìŠ¤í…œ")

    

    with gr.Row():

        with gr.Column(scale=2):

            receiver_input = gr.Textbox(label="ìˆ˜ì‹ ì ì´ë©”ì¼")

            subject_input = gr.Textbox(label="ì œëª©")

            content_input = gr.TextArea(label="ë³¸ë¬¸ ë‚´ìš©", lines=10)

            send_btn = gr.Button("ë©”ì¼ ë³´ë‚´ê¸°", variant="primary")

        

        with gr.Column(scale=1):

            current_log_id = gr.State()

            with gr.Group(visible=False) as feedback_area:

                gr.Markdown("### ğŸ§ ê²°ê³¼ ê²€ì¦")

                feedback_radio = gr.Radio(["ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤", "ì•„ë‹ˆìš”"], label="íŒë‹¨")

                feedback_btn = gr.Button("ì œì¶œ")

                feedback_msg = gr.Markdown("")



    send_btn.click(fn=process_email, inputs=[receiver_input, subject_input, content_input], outputs=[current_log_id, feedback_area])

    feedback_btn.click(fn=submit_feedback, inputs=[current_log_id, feedback_radio], outputs=feedback_msg)



demo.launch()
