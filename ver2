import gradio as gr
import smtplib
import sqlite3
import pandas as pd
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from datetime import datetime
from hanspell import spell_checker

# ==========================================
# 1. DB ì„¤ì • (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
# ==========================================
DB_NAME = "mail_data.db"

def init_db():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS mail_logs 
                 (id INTEGER PRIMARY KEY AUTOINCREMENT, 
                  body TEXT, typos TEXT, is_correct_feedback INTEGER, timestamp TEXT)''')
    conn.commit()
    conn.close()

init_db()

# ==========================================
# 2. ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜
# ==========================================
def send_email(receiver, subject, body):
    
    # --------------------------------------------------------
    # ë°œì‹ ì ì •ë³´ ì…ë ¥
    # --------------------------------------------------------
    sender_email = 'nextpaigeis@gmail.com'  # ë³¸ì¸ ì´ë©”ì¼ (ë°œì‹ ì)
    password = 'vcru fdkh ozul pugy'         # ì•± ë¹„ë°€ë²ˆí˜¸
    # --------------------------------------------------------
    
    # MIME ê°ì²´ ìƒì„±
    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = receiver
    msg['Subject'] = subject
    msg.attach(MIMEText(body, 'plain'))

    try:
        # Gmail SMTP ì„œë²„ì— ì—°ê²°í•˜ê³  ì´ë©”ì¼ ë³´ë‚´ê¸°
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()          # TLS ë³´ì•ˆ ì—°ê²°
        server.login(sender_email, password)  # ë¡œê·¸ì¸

        # ì´ë©”ì¼ ë°œì†¡
        text = msg.as_string()
        server.sendmail(sender_email, receiver, text)

        # ì„œë²„ ì—°ê²° ì¢…ë£Œ
        server.quit()
        return True
        
    except Exception as e:
        print(f"ì „ì†¡ ì—ëŸ¬: {e}")
        return False

# ==========================================
# 3. [ì•ˆì „ì¥ì¹˜] ë‚´ë¶€ ì˜¤íƒ€ ê²€ì‚¬
# ==========================================
def local_fallback_check(text):
    """ë„¤ì´ë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•˜ëŠ” ë¹„ìƒìš© ì‚¬ì „"""
    typo_dictionary = {
        "ì—­í™œ": "ì—­í• ",
        "ë´½ê² ìŠµë‹ˆë‹¤": "ëµ™ê² ìŠµë‹ˆë‹¤",
        "ê²°ì œ": "ê²°ì¬",
        "ì–´ë–»í•´": "ì–´ë–¡í•´",
        "ë˜ìš”": "ë¼ìš”",
        "ë¡œì¨": "ë¡œì„œ"
    }
    found_typos = []
    for wrong in typo_dictionary:
        if wrong in text:
            found_typos.append(wrong)
    return len(found_typos), found_typos

# ==========================================
# 4. ë©”ì¸ ë¡œì§ (ìˆ˜ì •ë¨: ë³´ê³ ì„œ ì‚­ì œ, ì˜¤íƒ€ ì•Œë¦¼ ì¶”ê°€)
# ==========================================
def process_email(receiver, subject, body):
    
    is_naver = False
    
    # 1. ë§ì¶¤ë²• ê²€ì‚¬ (ë„¤ì´ë²„ ì‹œë„ -> ì‹¤íŒ¨ì‹œ ë‚´ë¶€ì‚¬ì „)
    try:
        spelled = spell_checker.check(body)
        error_count = spelled.errors
        typo_list = [key for key, _ in spelled.words.items() if _ == 2]
        typos_str = ", ".join(typo_list)
        is_naver = True
    except:
        error_count, typo_list = local_fallback_check(body)
        typos_str = ", ".join(typo_list)
        is_naver = False

    # 2. DB ì €ì¥
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("INSERT INTO mail_logs (body, typos, is_correct_feedback, timestamp) VALUES (?, ?, ?, ?)",
              (body, typos_str, 0, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
    last_id = c.lastrowid
    conn.commit()
    conn.close()

    # 3. ê²°ê³¼ ë¶„ê¸°
    if error_count == 0:
        # ì˜¤íƒ€ ì—†ëŠ” ê²½ìš° -> ì •ìƒ ë°œì†¡ ì‹œë„
        if send_email(receiver, subject, body):
            msg = "âœ… ë°œì†¡ ì„±ê³µ!"
            if not is_naver: msg += " (ë°±ì—… ì‹œìŠ¤í…œ ë™ì‘)"
            gr.Info(msg)
            return last_id, gr.update(visible=False)
        else:
            gr.Warning("âŒ ë°œì†¡ ì‹¤íŒ¨: ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
            return last_id, gr.update(visible=False)
    else:
        # ------------------------------------------------------------
        # ì˜¤íƒ€ ìˆëŠ” ê²½ìš° -> ê²½ê³ ì°½ + ë‚´ ë©”ì¼ë¡œ ì•Œë¦¼ ë°œì†¡
        # ------------------------------------------------------------
        msg = f"ğŸš« ì˜¤íƒ€ {error_count}ê°œ ë°œê²¬! ë°œì†¡ ì¤‘ë‹¨.\n[ëª©ë¡] {typos_str}"
        gr.Warning(msg)
        
        # ì•Œë¦¼ ë©”ì¼ ë‚´ìš© êµ¬ì„±
        my_email = 'nextpaigeis@gmail.com' # [ì£¼ì˜] ìœ„ send_email í•¨ìˆ˜ì— ì ì€ ë³¸ì¸ ì´ë©”ì¼ê³¼ ë™ì¼í•˜ê²Œ ì ì–´ì£¼ì„¸ìš”
        alert_subject = f"[ê²½ê³ ] ì‘ì„± ì¤‘ì¸ ë©”ì¼ì—ì„œ ì˜¤íƒ€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
        alert_body = f"""
[ì‹œìŠ¤í…œ ì•Œë¦¼]
ì‘ì„±í•˜ì‹  ë©”ì¼ì—ì„œ ì˜¤íƒ€ê°€ ë°œê²¬ë˜ì–´ ë°œì†¡ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.

- ë°œê²¬ëœ ì˜¤íƒ€ ëª©ë¡: {typos_str}
- ì˜¤íƒ€ ê°œìˆ˜: {error_count}ê°œ

--------------------------------------------------
[ì‘ì„± ì›ë¬¸]
{body}
--------------------------------------------------
"""
        # ë°œì‹ ìì—ê²Œ ì•Œë¦¼ ë°œì†¡
        send_email(my_email, alert_subject, alert_body)
        
        return last_id, gr.update(visible=True)

# ==========================================
# 5. í”¼ë“œë°± í•¨ìˆ˜
# ==========================================
def submit_feedback(row_id, feedback_val):
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    val = 1 if feedback_val == "ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤" else 0
    c.execute("UPDATE mail_logs SET is_correct_feedback = ? WHERE id = ?", (val, row_id))
    conn.commit()
    conn.close()
    gr.Info("í”¼ë“œë°± ë°˜ì˜ ì™„ë£Œ!")
    return "ë°˜ì˜ ì™„ë£Œ"

# ==========================================
# 6. UI êµ¬ì„±
# ==========================================
with gr.Blocks(theme=gr.themes.Soft()) as demo:
    gr.Markdown("## ğŸ“§ ìŠ¤ë§ˆíŠ¸ ë©”ì¼ ì‹œìŠ¤í…œ")
    
    with gr.Row():
        with gr.Column(scale=2):
            receiver_input = gr.Textbox(label="ìˆ˜ì‹ ì ì´ë©”ì¼")
            subject_input = gr.Textbox(label="ì œëª©")
            content_input = gr.TextArea(label="ë³¸ë¬¸ ë‚´ìš©", lines=10)
            send_btn = gr.Button("ë©”ì¼ ë³´ë‚´ê¸°", variant="primary")
        
        with gr.Column(scale=1):
            current_log_id = gr.State()
            with gr.Group(visible=False) as feedback_area:
                gr.Markdown("### ğŸ§ ê²°ê³¼ ê²€ì¦")
                feedback_radio = gr.Radio(["ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤", "ì•„ë‹ˆìš”"], label="íŒë‹¨")
                feedback_btn = gr.Button("ì œì¶œ")
                feedback_msg = gr.Markdown("")

    send_btn.click(fn=process_email, inputs=[receiver_input, subject_input, content_input], outputs=[current_log_id, feedback_area])
    feedback_btn.click(fn=submit_feedback, inputs=[current_log_id, feedback_radio], outputs=feedback_msg)

demo.launch()
