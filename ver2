import gradio as gr
import smtplib
import sqlite3
import pandas as pd
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from datetime import datetime
from hanspell import spell_checker

# ==========================================
# 1. DB ì„¤ì •
# ==========================================
DB_NAME = "mail_data.db"

def init_db():
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS mail_logs 
                 (id INTEGER PRIMARY KEY AUTOINCREMENT, 
                  body TEXT, typos TEXT, is_correct_feedback INTEGER, timestamp TEXT)''')
    conn.commit()
    conn.close()

init_db()

# ==========================================
# 2. ì´ë©”ì¼ ë°œì†¡ í•¨ìˆ˜
# ==========================================
def send_email(receiver, subject, body):
    sender_email = 'ë°œì‹ ìì´ë©”ì¼@gmail.com'  # ë³¸ì¸ ì´ë©”ì¼
    password = 'ë¹„ë°€ë²ˆí˜¸16ìë¦¬'        # ì•± ë¹„ë°€ë²ˆí˜¸
    
    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = receiver
    msg['Subject'] = subject
    msg.attach(MIMEText(body, 'plain'))

    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(sender_email, password)
        server.sendmail(sender_email, receiver, msg.as_string())
        server.quit()
        return True
    except Exception as e:
        print(f"ì „ì†¡ ì—ëŸ¬: {e}")
        return False

# ==========================================
# 3. ë‚´ë¶€ ì˜¤íƒ€ ê²€ì‚¬
# ==========================================
def local_fallback_check(text):
    """ë„¤ì´ë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•˜ëŠ” ë¹„ìƒìš© ì‚¬ì „"""
    typo_dictionary = {
        "ì—­í™œ": "ì—­í• ",
        "ë´½ê² ìŠµë‹ˆë‹¤": "ëµ™ê² ìŠµë‹ˆë‹¤",
        "ê²°ì œ": "ê²°ì¬",
        "ì–´ë–»í•´": "ì–´ë–¡í•´",
        "ë˜ìš”": "ë¼ìš”",
        "ë¡œì¨": "ë¡œì„œ"
    }
    found_details = []
    
    for wrong, right in typo_dictionary.items():
        if wrong in text:
            found_details.append(f"'{wrong}' â†’ '{right}'")
            
    return len(found_details), found_details

# ==========================================
# 4. ë©”ì¸ ë¡œì§
# ==========================================
def process_email(receiver, subject, body):
    
    is_naver = False
    
    # ë©”ì¼ì— ë“¤ì–´ê°ˆ í•µì‹¬ ë‚´ìš© ë³€ìˆ˜
    mail_content_header = ""
    mail_content_body = ""

    # 1. ë§ì¶¤ë²• ê²€ì‚¬ ë¡œì§
    try:
        # [A] ë„¤ì´ë²„ ê²€ì‚¬ ì‹œë„
        spelled = spell_checker.check(body)
        error_count = spelled.errors
        
        # ë„¤ì´ë²„ì¸ ê²½ìš°: ì „ì²´ êµì • ë¬¸ì¥(2ë²ˆ ë‚´ìš©)ì„ ì¤€ë¹„
        full_corrected_text = spelled.checked 
        
        # DB ì €ì¥ìš© ì˜¤íƒ€ ëª©ë¡
        typo_list = [key for key, _ in spelled.words.items() if _ >= 1]
        typos_str = ", ".join(typo_list)
        
        # ë©”ì¼ ë³¸ë¬¸ ë‚´ìš© ì„¤ì • (ë„¤ì´ë²„ìš©)
        mail_content_header = "ğŸ“ ì „ì²´ ë¬¸ì¥ êµì • ì œì•ˆ"
        mail_content_body = full_corrected_text
            
        is_naver = True
        
    except:
        # [B] ì‹¤íŒ¨ ì‹œ ë‚´ë¶€ ì‚¬ì „ ì‚¬ìš©
        error_count, typo_details = local_fallback_check(body)
        
        # DB ì €ì¥ìš© ì˜¤íƒ€ ëª©ë¡
        typos_str = ", ".join(typo_details)
        
        # ë©”ì¼ ë³¸ë¬¸ ë‚´ìš© ì„¤ì • (ë‚´ë¶€ ì‚¬ì „ìš© -> 1ë²ˆ ë‚´ìš©)
        correction_guide = "\n".join([f"- {item}" for item in typo_details])
        
        mail_content_header = "ğŸ’¡ êµì • ê°€ì´ë“œ (ìˆ˜ì • ì œì•ˆ)"
        mail_content_body = correction_guide
        
        is_naver = False

    # 2. DB ì €ì¥
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    c.execute("INSERT INTO mail_logs (body, typos, is_correct_feedback, timestamp) VALUES (?, ?, ?, ?)",
              (body, typos_str, 0, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
    last_id = c.lastrowid
    conn.commit()
    conn.close()

    # 3. ê²°ê³¼ ë¶„ê¸° ë° ë©”ì¼ ë°œì†¡
    if error_count == 0:
        if send_email(receiver, subject, body):
            msg = "âœ… ë°œì†¡ ì„±ê³µ!"
            if not is_naver: msg += " (ë°±ì—… ì‹œìŠ¤í…œ ë™ì‘)"
            gr.Info(msg)
            return last_id, gr.update(visible=False)
        else:
            gr.Warning("âŒ ë°œì†¡ ì‹¤íŒ¨: ê³„ì • ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
            return last_id, gr.update(visible=False)
    else:
        # ------------------------------------------------------------
        # ì˜¤íƒ€ ë°œê²¬ -> ì•Œë¦¼ ë©”ì¼ ë°œì†¡ (ì¡°ê±´ë¶€ ë‚´ìš© ì ìš©)
        # ------------------------------------------------------------
        msg_ui = f"ğŸš« ì˜¤íƒ€ {error_count}ê°œ ë°œê²¬! ë°œì†¡ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤."
        gr.Warning(msg_ui)
        
        my_email = 'ë°œì‹ ìì´ë©”ì¼@gmail.com' 
        alert_subject = f"[ê²½ê³ ] ì‘ì„± ì¤‘ì¸ ë©”ì¼ì—ì„œ {error_count}ê°œì˜ ì˜¤íƒ€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
        
        alert_body = f"""
[ì‹œìŠ¤í…œ ì•Œë¦¼: ì˜¤íƒ€ ê°ì§€ ë³´ê³ ì„œ]
ì‘ì„±í•˜ì‹  ì´ë©”ì¼ ë°œì†¡ì´ ì¼ì‹œ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ êµì • ì œì•ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{mail_content_header}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{mail_content_body}
"""
        # ë‚˜ì—ê²Œ ì•Œë¦¼ ë³´ë‚´ê¸°
        send_email(my_email, alert_subject, alert_body)
        
        return last_id, gr.update(visible=True)

# ==========================================
# 5. í”¼ë“œë°± í•¨ìˆ˜
# ==========================================
def submit_feedback(row_id, feedback_val):
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()
    val = 1 if feedback_val == "ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤" else 0
    c.execute("UPDATE mail_logs SET is_correct_feedback = ? WHERE id = ?", (val, row_id))
    conn.commit()
    conn.close()
    gr.Info("í”¼ë“œë°± ë°˜ì˜ ì™„ë£Œ!")
    return "ë°˜ì˜ ì™„ë£Œ"

# ==========================================
# 6. UI êµ¬ì„±
# ==========================================
with gr.Blocks(theme=gr.themes.Soft()) as demo:
    gr.Markdown("## ğŸ“§ ìŠ¤ë§ˆíŠ¸ ë©”ì¼ ì‹œìŠ¤í…œ")
    
    with gr.Row():
        with gr.Column(scale=2):
            receiver_input = gr.Textbox(label="ìˆ˜ì‹ ì ì´ë©”ì¼")
            subject_input = gr.Textbox(label="ì œëª©")
            content_input = gr.TextArea(label="ë³¸ë¬¸ ë‚´ìš©", lines=10, placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.")
            send_btn = gr.Button("ë©”ì¼ ë³´ë‚´ê¸°", variant="primary")
        
        with gr.Column(scale=1):
            current_log_id = gr.State()
            with gr.Group(visible=False) as feedback_area:
                gr.Markdown("### ğŸ§ ê²°ê³¼ ê²€ì¦")
                feedback_radio = gr.Radio(["ë„¤, ì˜¤íƒ€ê°€ ë§ìŠµë‹ˆë‹¤", "ì•„ë‹ˆìš”"], label="íŒë‹¨")
                feedback_btn = gr.Button("ì œì¶œ")
                feedback_msg = gr.Markdown("")

    send_btn.click(fn=process_email, inputs=[receiver_input, subject_input, content_input], outputs=[current_log_id, feedback_area])
    feedback_btn.click(fn=submit_feedback, inputs=[current_log_id, feedback_radio], outputs=feedback_msg)

demo.launch()
